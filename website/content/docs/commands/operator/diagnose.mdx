---
layout: docs
page_title: operator diagnose - Command
description: |-
  The "operator diagnose" command troubleshoots Vault startup issues, such as 
  TLS configuration or auto-unseal. It should be run using the same environment 
  variables and configuration files as the "vault server" command, so that 
  startup problems can be accurately reproduced.

---

# operator diagnose

Troubleshoots Vault startup issues, such as TLS configuration or auto-unseal.

<CodeBlockConfig hideClipboard>

```shell-session
$ vault operator diagnose [flags]

$ vault operator diagnose [-help | -h]
```

</CodeBlockConfig>

## Description

`operator diagnose` troubleshoots Vault startup issues, such as TLS configuration
or auto-unseal. It should be run using the same environment variables and
configuration files as the "vault server" command, so that startup problems can
be accurately reproduced.

You should primarily use this command when Vault is down or partially
inoperational. You can use `operator diagnose` safely regardless of the state Vault
is in, but may return meaningless results for some of the test cases if Vault is
already running.

If you run the `diagnose` command proactively, either before a server 
starts or while a server is operational, consult the documentation 
on the individual checks below to see which checks are returning false error 
messages or warnings.

### Return status and output

`operator diagnose` outputs results with one of three status prefixes:

| Prefix | Description |
| --- | --- |
| `success` | The check passed successfully with no issues detected. |
| `warning` | The check passed but identified potential issues that need investigation. Warnings are common and serve as helpful starting points for troubleshooting. |
| `failure` | The check failed, indicating a critical issue that requires immediate attention. Failures represent serious problems that are likely impacting Vault's operation. |

The command may also output additional guidance lines in purple text that are
not prefixed. These advice lines provide helpful suggestions for resolving any
warnings or failures encountered during diagnosis.

Status prefixes propagate upward through nested checks based on severity, with
failures taking precedence over warnings, and warnings taking precedence over
successes. For example, if a TLS check nested under the Storage check fails, the
Storage check will display a `[ failure ]` prefix to indicate the critical issue
below.

### Diagnose checks

The following section details the various checks that Diagnose runs. Check names
in documentation will be separated by slashes to denote that they are nested,
when applicable. For example, a check documented as `A / B` will show up as `B` 
in the `operator diagnose` output, and will be nested (indented) under `A`. 

#### Vault diagnose

`Vault Diagnose` is the top level check that contains the rest of the checks. 
It will report the status of the check.

#### Check operating system / check open file limit

`Check Open File Limit` verifies that the open file limit value is set high 
enough for Vault to run effectively. We recommend setting these limits to at 
least 1024768. 

This check will be skipped on openbsd, arm, and windows. 

#### Check operating system / check disk usage

`Check Disk Usage` will report disk usage for each partition. For each partition
on a production host, we recommend having at least 5% of the partition free to 
use, and at least 1 GB of space. 

This check will be skipped on openbsd and arm.

#### Parse configuration

`Parse Configuration` will check the vault server config file for syntax errors.
It will check for extra values in the configuration file, repeated stanzas, and
stanzas that do not belong in the configuration file (for example, a `tcpp` 
listener stanza as opposed to a `tcp` listener). 

Currently, the `storage` stanza is not checked. 

#### Check storage / create storage backend

`Create Storage Backend` ensures that the storage stanza configured in the Vault
server config has enough information to create a storage object internally.
Common errors will have to do with misconfigured fields in the storage stanza. 

#### Check storage / check consul TLS

`Check Consul TLS` verifies TLS information included in the storage stanza if 
the storage type is Consul. If a certificate chain is provided, Diagnose parses
the root, intermediate, and leaf certificates, and checks each one for correctness. 

#### Check storage / check consul direct storage access

`Check Consul Direct Storage Access` is a Consul-specific check that ensures 
Vault is not accessing the Consul server directly, but rather through a local 
agent. 

#### Check storage / check raft folder permissions

`Check Raft Folder Permissions` computes the permissions on the Raft folder, 
checks that a boltDB file has been initialized within the folder previously, 
and ensures that the folder is not too permissive, but at the same time has 
enough permissions to be used. The raft folder should not have `other` 
permissions, but should have `group rw` or `owner rw`, depending on different 
setups. This check also warns if it detects a symlink being used. 

Note that this check will warn that a raft file has not been created if diagnose
is run without any pre-existing server runs.

This check will be skipped on windows. 

#### Check storage / check raft folder ownership

`Check Raft Folder Ownership` ensures that Vault does not need to run as root
to access the boltDB folder. 

Note that this check will warn that a raft file has not been created if diagnose
is run without any pre-existing server runs. 

This check will be skipped on windows. 

#### Check storage / check for raft quorum

`Check For Raft Quorum` uses the FSM to ensure that there were an odd number of
voters in the raft quorum when Vault was last running. 

Note that this check will warn that there are 0 voters if diagnose is run without
any pre-existing server runs. 

#### Check storage / check storage access

`Check Storage Access` will try to write a dud value, named `diagnose/latency/<uuid>`,
to storage. Ensure that there is no important data at this location before running
diagnose, as this check will overwrite that data. This check will then try to list
and read the value it wrote to ensure the name and value is as expected. 

`Check Storage Access` will warn if any operation takes longer than 100ms, and
error out if the entire check takes longer than 30s. 

#### Check service discovery / check consul service discovery TLS

`Check Consul Service Discovery TLS` verifies TLS information included in the 
service discovery stanza if the storage type is Consul. If a certificate chain 
is provided, Diagnose parses the root, intermediate, and leaf certificates, and 
checks each one for correctness. 

#### Check service discovery / check consul direct service discovery

`Check Consul Direct Service Discovery` is a Consul-specific check that ensures
Vault is not accessing the Consul server directly, but rather through a local
agent. 

#### Create Vault server configuration seals

`Create Vault Server Configuration Seals` creates seals from the Vault
configuration stanza and verifies they can be initialized and finalized. 

#### Check transit seal TLS

`Check Transit Seal TLS` checks the TLS client certificate, key, and CA 
certificate provided in a transit seal stanza (if one exists) for correctness. 

#### Create core configuration / initialize randomness for core

`Initialize Randomness for Core` ensures that Vault has access to the 
`randReader` that the Vault core uses. 

#### HA storage

This check and any nested checks will be the same as the `Check Storage` checks.
The only difference is that the checks here will be run on whatever is specified
in the `ha_storage` section of the Vault configuration, as opposed to the 
`storage` section. 

#### Determine redirect address

`Determine Redirect Address` ensures that one of the `VAULT_API_ADDR`, 
`VAULT_REDIRECT_ADDR`, or `VAULT_ADVERTISE_ADDR` environment variables are set,
or that the redirect address is specified in the Vault configuration.

#### Check cluster address

Parses the cluster address from the `VAULT_CLUSTER_ADDR` environment variable, 
or from the redirect address or cluster address specified in the Vault 
configuration, and checks that the address is of the form `host:port`. 

#### Check core creation

`Check Core Creation` verifies the logical configuration checks that Vault does 
when it creates a core object. These are runtime checks, meaning any errors 
thrown by this diagnose test will also be thrown by the Vault server itself when
it is run. 

#### Check for autoloaded license

`Check For Autoloaded License` is an Enterprise-specific diagnose check, which 
verifies that Vault has access to a valid autoloaded license that will not expire
in the next 30 days.

#### Start listeners / check listener TLS

`Check Listener TLS` verifies the server certificate file and key are valid and 
matching. It also checks the client CA file, if one is provided, for a valid 
certificate, and performs the standard runtime listener checks on the listener 
configuration stanza, such as verifying that the minimum and maximum TLS versions 
are within the bounds of what Vault supports. 

Like all the other Diagnose TLS checks, it will warn if any of the certificates 
provided are set to expire within the next month. 

#### Start listeners / create listeners

`Create Listeners` uses the listener configuration to initialize the listeners, 
erroring with a server error if anything goes wrong. 

#### Check autounseal encryption

`Check Autounseal Encryption` will initialize the barrier using the seal stanza,
if the seal type is not a shamir seal, and use it to encrypt and decrypt a dud
value. 

#### Check server before runtime

`Check Server Before Runtime` achieves parity with the server run command, running
through the runtime code checks before the server is initialized to ensure that
nothing fails. This check will never fail without another diagnose check
failing. 

## Command arguments

<br />

None.

## Command options

None.

## Command flags

<br />

@include 'global-settings/both/format.mdx'

<br /><hr /><br />

@include 'cli/operator/flags/config.mdx'

<br /><hr /><br />

@include 'cli/operator/flags/debug.mdx'

<br /><hr /><br />

@include 'cli/operator/flags/skip.mdx'

## Examples

Start diagnose with a configuration file:

```shell-session
$ vault operator diagnose -config=/etc/vault/config.hcl
```

Perform a diagnostic check while Vault is still running:

```shell-session
$ vault operator diagnose -config=/etc/vault/config.hcl -skip=listener
```