---
layout: docs
page_title: Rate limit quotas - collective, by IP, by entity
description: >-
  Implement protections to prevent misbehaving applications and clients from impacting Vault performance.
---

# Rate limit quotas - collective, by IP, by entity

As the number of Vault client applications increases, the incoming requests to
Vault can degrade Vault's performance. To protect your Vault environment's
stability and network, as well as storage resource consumption from runaway
application behavior and distributed denial of service (DDoS) attack, use [rate
limit quotas](/vault/docs/configuration/create-lease-count-quota) and [lease
count quotas](/vault/docs/configuration/create-rate-limit-quota).

For Vault Enterprise clusters, the rate limit quota supports **`group_by`**
option to define more fine-grained rate limits to control how traffic enters
their cluster.

The available `group_by` modes are:

- `ip` - groups requests by their source IP address (`group_by` defaults to `ip`
  if unset)

  <Note title="Vault Community Edition">

  The `ip` mode is the only supported mode in the community edition of Vault.

  </Note>

- `none` - groups together all requests that match the rate limit quota rule

- `entity_then_ip` - groups requests by their entity ID for authenticated
  requests that carry one, or by their IP for unauthenticated requests (or
  requests whose authentication is not connected to an entity)

- `entity_then_none` - groups requests by their entity ID when available, but
  the rest is all grouped together (for example, unauthenticated requests, and
  requests with authentication that is not connected to an entity)

The `group_by` option with `entity_then_ip` or `entity_then_none` mode allows
you to set a secondary rate limit (**`secondary_rate`**). This rate limit applies to
the requests that fall under the `ip` or `none` groupings, while the
authenticated requests that contain an entity ID are subject to the primary rate
limit set by the `rate` parameter.

The default behavior is to group requests by their source IP addresses. The
`entity_then_none` or `entity_then_ip` mode groups requests based on their
attached entity. This helps when your organization have:

- many workloads using the same IP
- single workloads using many IPs which may scale up or down
- dynamic IPs that change frequently

The group by `none` option creates one bucket for all requests at the designated
level (namespace, mount, or path) for that rate limit. For example, if your
organization provides Vault as a service to your customers, you segregate the
customers each into their own namespace. The default behavior of any rate limit
set for the namespace creates a bucket per IP. If the desired behavior is to set
a collective rate limit for all entities and workloads coming into the
namespace, the `none` option can achieve that.


![Diagram indicating possible user paths](/img/resource-quotas/group-by_light.png#light-theme-only)
![Diagram indicating possible user paths](/img/resource-quotas/group-by_dark.png#dark-theme-only)


<Note title="Rate limit granularity">

You can define quotas on namespaces, mounts, and paths. The most granular rate
limit quota takes effect on the requests. 

</Note>


### Example

The command below creates a rate limit quota with rate of 1,000 requests per
second with `group_by` is set to `entity_then_none`, and the secondary rate is
2,000 requests per second.

```shell-session
$ vault write sys/quotas/rate-limit/my-rate \
    rate=1000 \
    group_by=entity_then_none \
    secondary_rate=2000     
```

## Best practices

The `group_by` option supplements the existing quota features.

![Diagram indicating possible user paths](/img/resource-quotas/resource-quotas-use-cases_light.png#light-theme-only)
![Diagram indicating possible user paths](/img/resource-quotas/resource-quotas-use-cases_dark.png#dark-theme-only)

- Use [Terraform Vault
  provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs/resources/quota_rate_limit)
  to configure and implement quotas instead of making API calls.

- Define at least one lease count quota to protect your Vault cluster from
  [lease explosions](/vault/docs/configuration/prevent-lease-explosions).

- Configure low limits at the namespace level, and higher limits at the specific
problematic path. The most granular rate limit quotas takes the effect. 

  ![Diagram indicating possible user paths](/img/resource-quotas/quota-granularity_light.png#light-theme-only)
  ![Diagram indicating possible user paths](/img/resource-quotas/quota-granularity_dark.png#dark-theme-only)
