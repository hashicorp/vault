---
layout: docs
page_title: Identity-based rate limit quotas
description: >-
  Implement protections to prevent misbehaving applications and clients from impacting Vault performance.
---

# Identity-based rate limit quotas

As the number of Vault client applications increases, the incoming requests to
Vault can degrade Vault's performance. The issue is often caused by
applications that are:

- Generating an unbounded number of leases and/or loading too much data into
  Vault leading to exhausting storage backend's available memory
- Consuming an erroneously large amount of bandwidth leading to internal
  throttling of the Vault cluster as a whole

Use [rate limit quotas](/vault/docs/configuration/create-lease-count-quota) and
[lease count quotas](/vault/docs/configuration/create-rate-limit-quota) to
protect your Vault environment's stability and network, as well as storage
resource consumption from runaway application behavior and distributed denial of
service (DDoS) attack.


Vault Enterprise permits organizations to define more fine-grained rate limits
to how traffic enters their Vault cluster. Identity-based rate limit quotas use
`group_by` options to create buckets for requests.

<table>
  <thead>
    <tr>
      <th style={{verticalAlign: 'middle'}}>Group_by option</th>
      <th style={{verticalAlign: 'middle'}}>Description</th>
    </tr>
  </thead>

  <tbody>

  <tr>
    <td><code>ip</code></td>
    <td>
      Creates buckets based on the IP addresses. (Default)
    </td>
  </tr>

  <tr>
    <td><code>entity_then_none</code></td>
    <td>
     Groups requests on namespace, mount, or path by entity ID. The rate applies to the each bucket created. Requests
     without associated entity ID are handled by a collective secondary quota.
    </td>
  </tr>

  <tr>
    <td><code>entity_then_ip</code></td>
    <td>
      Groups requests on namespace, mount, or path by entity ID. The rate applies to the each bucket created. Requests without associated entity ID are bucketed by IP, and the rate applies to each bucket. This option is recommended if your organization has reliably mappable IPs.
    </td>
  </tr>

  <tr>
    <td><code>secondary_rate</code></td>
    <td>
      Allows organizations to set a separate rate for entity ID.<br/><br/>
    </td>
  </tr>

  <tr>
    <td><code>none</code></td>
    <td>
      Creates one bucket for the namespace, path, or mount and collectively limits all traffic to that target.
    </td>
  </tr>

  </tbody>
</table>

The default behavior is to group requests by IP addresses. Group requests by
 entity (`entity_than_none` or `entity_then_ip`) option creates buckets based on
the attached entity. This helps when your organization have:

- many workloads using the same IP
- single workloads using many IPs which may scale up or down
- dynamic IPs that change frequently

The group by `none` option creates one bucket for all requests at the designated
level (namespace, mount, or path) for that rate limit. For example, if your
organization provides Vault as a service to your customers, you segregate the
customers each into their own namespace. The default behavior of any rate limit
set for the namespace creates a bucket per IP. If the desired behavior is to set
a collective rate limit for all entities and workloads coming into the
namespace, the `none` option can achieve that.

<Note title="Rate limit granularity">

You can define quotas on namespaces, mounts, and paths. The most granular rate
limit quota takes effect on the requests. 

</Note>


### Example

The command below creates a rate limit quota with rate of 1000 requests per
second with `group_by` is set to `entity_then_none`, and the secondary rate is
2000 requests per second.

```shell-session
$ vault write sys/quotas/rate-limit/my-rate \
    rate=1000 \
    group_by=entity_then_none \
    secondary_rate=2000     
```

## Best practices

The `group_by` option supplements the existing quota features.

![Diagram indicating possible user paths](/img/resource-quotas/resource-quotas-use-cases_light.png#light-theme-only)
![Diagram indicating possible user paths](/img/resource-quotas/resource-quotas-use-cases_dark.png#dark-theme-only)

- Use [Terraform Vault
  provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs/resources/quota_rate_limit)
  to configure and implement quotas instead of making API calls.

- Define at least one lease count quota to protect your Vault cluster from
  [lease explosions](/vault/docs/configuration/prevent-lease-explosions).

- Configure low limits at the namespace level, and higher limits at the specific
problematic path. The most granular rate limit quotas takes the effect. 

  ![Diagram indicating possible user paths](/img/resource-quotas/quota-granularity_light.png#light-theme-only)
  ![Diagram indicating possible user paths](/img/resource-quotas/quota-granularity_dark.png#dark-theme-only)
