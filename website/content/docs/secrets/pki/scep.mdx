---
layout: docs
page_title: Simple Certificate Enrollment Protocol (SCEP)
description: >-
   Understand the configuration and limitations of Vault's PKI secrets engine implementation of the Simple Certificate Enrollment Protocol (SCEP).
---

# Simple Certificate Enrollment Protocol (SCEP) <EnterpriseAlert inline="true" />

This document covers configuration and limitations of Vault's PKI Secrets Engine
implementation of the [SCEP](https://datatracker.ietf.org/doc/html/rfc8894) <EnterpriseAlert inline="true" />.

## What is Simple Certificate Enrollment Protocol (SCEP)?

SCEP is an IETF standardized protocol, [RFC 8894](https://datatracker.ietf.org/doc/html/rfc8894),
that allows clients to acquire client certificates and associated
Certificate Authority (CA) certificates.

## Enabling SCEP support on a Vault PKI mount

The following is a list of steps required to configure an existing PKI
mount to serve SCEP clients. Each of which can be broken down within three main
categories.

 1. [Authentication mechanisms](#configuring-scep-authentication-mounts)
 2. [Updating PKI tunable parameters](#updating-the-pki-mount-tunable-parameters)
 3. [PKI SCEP configuration](#pki-scep-configuration)

### Configuring SCEP Authentication mounts

The Vault SCEP implementation supports a few different authentication mechanisms in
two categories.

 * Challenge Based authentication
   - [Intune authentication](/vault/docs/auth/scep)
   - [Static challenge authentication](/vault/docs/auth/scep)
 * [Certificate Authentication](/vault/docs/auth/cert)

For SCEP challenge based authentication one of either static challenge or Intune mechanisms
can be used to authenticate clients within a given PKI mount. This is controlled
by configuring Intune within the PKI mount's SCEP configuration, otherwise we fallback
to using static challenges.

Certificate authentication can optionally be used for requests without a challenge value.
This is useful for clients that are renewing their certificate without
requiring the original challenge value.

The static challenge and Intune authentication mechanisms use a dedicated SCEP
authentication mount within the same namespace, while the certificate authentication
mechanism uses a configured certificate authentication mount. Both of these mounts
are used to validate the client provided credentials along with the client's ACL policy.

For proper accounting, mounts supporting SCEP authentication should be
dedicated to this purpose, and should not be shared with other workflows. In other words,
create a new auth mount for SCEP even if you already have one of the same
type for other purposes.

When setting up the authentication mount for SCEP clients, the token type must
be configured to return [batch tokens](/vault/docs/concepts/tokens#batch-tokens).
Batch tokens are required to avoid an excessive amount of leases being generated
and persisted as every SCEP incoming request needs to be authenticated.

If using the `sign-verbatim` or `role:my-role-name` as a path policy, the following
ACL policy will allow an authenticated client access the required PKI SCEP paths.
```
path “pki/scep” {
  capabilities=[“read“, “update”, “create”]
}
path “pki/scep/pkiclient.exe” {
  capabilities=[“read“, “update”, “create”]
}
```

For a role base path policy, this sample policy can be used
```
path “pki/roles/my-role-name/scep” {
  capabilities=[“read“, “update”, “create”]
}
path “pki/roles/my-role-name/scep/pkiclient.exe” {
  capabilities=[“read“, “update”, “create”]
}
```

##### Sample SCEP Authentication Mounts

```
vault auth enable scep
vault write auth/scep/role/static-challenge-1 \
    auth_type="static-challenge" \
    challenge=${SCEP_PASS} \
    token_policies="access-scep" \
    token_type="batch"
```

```
vault auth enable cert
vault write auth/cert/certs/scep-ca \
    display_name="SCEP Client CA" \
    token_policies="access-scep" \
    certificate="${CERTIFICATE}" \
    token_type="batch" \
    allowed_common_names="${HOSTNAME}"
```

```
vault write auth/scep/role/intune \
 auth_type="intune" \
 token_policies="access-scep" \
 token_type="batch"
```

#### Updating the PKI mount tunable parameters

Once the authentication mount has been created and configured, the authentication mount's accessor
will need to be captured and added within the PKI mount's [delegated auth accessors](/vault/api-docs/system/mounts#delegated_auth_accessors).

To get an authentication mount's accessor field, the following command can be used.

```shell-session
$ vault read -field=accessor sys/auth/scep
$ vault read -field=accessor sys/auth/cert
```

These field accessors are then added to the mount's delegated auth accessors.

```shell-session
$ vault secrets tune \
  -delegated-auth-accessors="auth_scep_e2f4f6d5" \
  -delegated-auth-accessors="auth_cert_4088ac2d" \
  pki
```

#### PKI SCEP configuration

The following is an example of a complete SCEP configuration, with two different authentication
methods - using certificate authentication and a static secret SCEP authentication.

The `default_path_policy` would use the existing `scep-clients` PKI role for restrictions and defaults,
leveraging the issuer specified within the role.

```shell-session
vault write pki_int/config/scep -<<EOC
{
  "enabled": true,
  "default_path_policy": "role:scep-clients",
  "authenticators": {
    "scep": {
      "accessor": "${SCEP_ACCESSOR}",
      "scep_role": "static-challenge-1"
    },
    "cert": {
      "accessor": "${CERT_ACCESSOR}",
      "cert_role": "scep-ca"
    }
  }
}
EOC
```

#### PKI SCEP configuration with Intune

The following is an example of a complete SCEP configuration using Intune authentication. Note that the
SCEP auth mount must have a role configured with an auth_type of `intune`. For the Intune authentication
credentials within the PKI mount's SCEP configuration, the tenant ID, client ID, and client secret can be
provided as environment variables, leverage Azure managed identities, or hardcoded into the configuration.
Note that all the `intune` specific fields within the `external_validation` block also accept using
[indirect value references](/vault/docs/configuration/seal#indirect-value-references)

```shell-session
vault write pki_int/config/scep -<<EOC
{
  "enabled": true,
  "default_path_policy": "role:scep-clients",
  "authenticators": {
    "scep": {
      "accessor": "${SCEP_ACCESSOR}",
      "scep_role": "intune"
    }
  }
  "external_validation": {
    "intune": {
      "tenant_id": "${INTUNE_TENANT_ID}",
      "client_id": "${INTUNE_CLIENT_ID}",
      "client_secret": "${INTUNE_CLIENT_SECRET}"
    }
  }
}
```

## Limitations

The SCEP implementation as noted above allow one type of challenge authentication, so either static challenge or Intune
for a given PKI mount. If you require both authentication methods, you will need to create separate PKI mounts, that
can point to either a shared SCEP auth mount or separate SCEP auth mounts.

### Matching different static challenge values

It is possible for a PKI mount to use different static challenge values. The SCEP auth
mount will need multiple roles configured of `auth_type` `static-challenge`, each with a different `challenge` value.
Within the PKI mount's SCEP configuration, the `scep_role` field will need to be left blank. With that set up the PKI
mount login attempt will be tried against the various SCEP auth roles.

### Intune Support

Intune clients add an additional `/pkiclient.exe` path to the configured SCEP request. Make sure that
the access policies associated with the SCEP role within the SCEP auth mount provide access to this path, such as

```hcl
path “pki/scep” {
  capabilities=[“read“, “update”, “create”]
}
path “pki/scep/pkiclient.exe” {
  capabilities=[“read“, “update”, “create”]
}
```

During internal testing, we noticed Intune clients failing to match the CA certificate when the GetCACerts request
returned a full certificate chain instead of the issuer CA certificate by itself. If you experience this issue, you
can force the SCEP response to only return the issuer CA certificate by setting the `return_full_ca_chain` field to `false`
within the PKI mount's SCEP configuration.

### JAMF Pro Support

JAMF Pro is supported in the static secret configuration.

## API

The PKI secrets engine has a full HTTP API. Please see the
[PKI secrets engine API](/vault/api-docs/secret/pki) for more details.
