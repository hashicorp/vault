<KvPageHeader @breadcrumbs={{@breadcrumbs}} @isEngineView={{true}} @pageTitle={{@backend}}>
  <:tabLinks>
    <LinkTo @route={{@routeName}} data-test-secrets-tab={{@routeName}}>Secrets</LinkTo>
    <LinkTo @route="configuration" data-test-secrets-tab="Configuration">Configuration</LinkTo>
  </:tabLinks>
  {{! TODO checks for if list >0 show filter }}
  <:toolbarFilters>
    {{#unless @noMetadataListPermissions}}
      <KvListFilter
        @secrets={{@secrets}}
        @mountPoint={{this.mountPoint}}
        @filterValue={{@filterValue}}
        @pageFilter={{@pageFilter}}
      />
    {{/unless}}
  </:toolbarFilters>

  <:toolbarActions>
    <ToolbarLink data-test-toolbar-create-secret @route="create" @query={{hash initialKey=@filterValue}} @type="add">Create
      secret</ToolbarLink>
  </:toolbarActions>
</KvPageHeader>

{{#if @noMetadataListPermissions}}
  <div class="box is-fullwidth is-shadowless has-tall-padding">
    <div class="selectable-card-container one-card">
      <OverviewCard
        @cardTitle="View secret"
        @subText="Type the path of the secret you want to view. Include a trailing slash to navigate to the list view."
      >
        <div class="has-top-margin-m is-flex">
          <InputSearch
            @id="search-input-kv-secret"
            @initialValue={{@model.pathToSecret}}
            @onChange={{this.handleSecretPathInput}}
            @placeholder="secret/"
            data-test-view-secret
          />
          <button
            type="button"
            class="button is-secondary"
            disabled={{not this.secretPath}}
            {{on "click" this.transitionToSecretDetail}}
            data-test-get-secret-detail
          >
            {{this.buttonText}}
          </button>
        </div>
      </OverviewCard>
    </div>
  </div>
{{else}}
  {{#if @secrets}}
    {{#each @secrets as |secret|}}
      <LinkedBlock
        data-test-list-item={{secret.path}}
        class="list-item-row"
        @params={{array (if secret.pathIsDirectory "list-directory" "secret.details") secret.fullSecretPath}}
        @linkPrefix={{this.mountPoint}}
      >
        <div class="level is-mobile">
          <div class="level-left">
            <div>
              <Icon @name="user" class="has-text-grey-light" />
              <span class="has-text-weight-semibold is-underline">
                {{secret.path}}
              </span>
            </div>
          </div>
          <div class="level-right is-flex is-paddingless is-marginless">
            <div class="level-item">
              <PopupMenu>
                <nav class="menu">
                  <ul class="menu-list">
                    {{#if secret.pathIsDirectory}}
                      <li>
                        <LinkTo @route="list-directory" @model={{secret.fullSecretPath}}>
                          Content
                        </LinkTo>
                      </li>
                    {{else}}
                      <li>
                        <LinkTo @route="secret.details" @model={{secret.fullSecretPath}}>
                          Details
                        </LinkTo>
                      </li>
                      {{#if secret.canReadMetadata}}
                        <li>
                          <LinkTo @route="secret.metadata.versions" @model={{secret.fullSecretPath}}>
                            View version history
                          </LinkTo>
                        </li>
                      {{/if}}
                      {{! ARG TODO check that you don't also need create (this checks for update) }}
                      {{#if secret.canEditData}}
                        <li>
                          <LinkTo @route="secret.details.edit" @model={{secret.fullSecretPath}}>
                            Create new version
                          </LinkTo>
                        </li>
                      {{/if}}
                      {{#if secret.canDeleteMetadata}}
                        <li>
                          <ConfirmAction
                            @buttonClasses="link is-destroy"
                            @onConfirmAction={{fn this.onDelete secret}}
                            @confirmMessage="This will permanently delete this secret and all its versions."
                            @cancelButtonText="Cancel"
                            data-test-secret-delete="true"
                          >
                            Permanently delete
                          </ConfirmAction>
                        </li>
                      {{/if}}
                    {{/if}}
                  </ul>
                </nav>
              </PopupMenu>
            </div>
          </div>
        </div>
      </LinkedBlock>
    {{/each}}
  {{else}}
    {{#if @filterValue}}
      <EmptyState @title="There are no secrets matching &quot;{{@filterValue}}&quot;." />
    {{else}}
      <EmptyState
        data-test-secret-list-empty-state
        @title="No secrets yet"
        @message="When created, secrets will be listed here. Create a secret to get started."
      >
        <LinkTo class="has-top-margin-xs" @route="create">
          Create secret
        </LinkTo>
      </EmptyState>
    {{/if}}
  {{/if}}
{{/if}}