/**
 * Copyright (c) HashiCorp, Inc.
 * SPDX-License-Identifier: BUSL-1.1
 */

import { module, test } from 'qunit';
import { setupRenderingTest } from 'ember-qunit';
import { render, fillIn, click, findAll } from '@ember/test-helpers';
import { hbs } from 'ember-cli-htmlbars';
import { setupMirage } from 'ember-cli-mirage/test-support';
import { GENERAL } from 'vault/tests/helpers/general-selectors';

const SELECTORS = {
  toggleGroup: (name) => `[data-test-toggle-group="${name}"]`,
};

module('Integration | Component | totp/key-form', function (hooks) {
  setupRenderingTest(hooks);
  setupMirage(hooks);

  hooks.beforeEach(function () {
    this.store = this.owner.lookup('service:store');
  });

  test('it should save new key generated by Vault', async function (assert) {
    assert.expect(6);

    this.server.post('/totp/keys/test', (schema, req) => {
      assert.ok(true, 'Request made to save key');
      return JSON.parse(req.requestBody);
    });

    this.model = this.store.createRecord('totp-key');

    this.onSubmit = () => assert.ok(true, 'onSubmit callback fires on save success');
    await render(hbs`
      <TotpEdit
        @mode="create"
        @onSubmit={{this.onSubmit}}
        @model={{this.model}}
    />
    `);

    assert.dom('[data-test-secret-header]').hasText('Create a TOTP key', 'Form title renders');

    // check validation errors
    await click(GENERAL.saveButton);

    const validationErrors = findAll(GENERAL.inlineAlert);
    assert.dom(validationErrors[0]).hasText(`Name can't be blank.`, 'Validation messages are shown for name');
    assert
      .dom(validationErrors[1])
      .hasText(
        `Issuer can't be blank when when the key is generated by Vault.`,
        'Validation messages are shown for issuer'
      );
    assert
      .dom(validationErrors[2])
      .hasText(
        `Account name can't be blank when the key is generated by Vault.`,
        'Validation messages are shown for account name'
      );
    assert.dom(validationErrors[3]).hasText('There are 3 errors with this form.', 'Renders form error count');

    await fillIn('[data-test-input="name"]', 'test');
    await fillIn('[data-test-input="issuer"]', 'test');
    await fillIn('[data-test-input="accountName"]', 'test');

    await click(GENERAL.saveButton);
  });

  test('it should save new key that is not generated by Vault', async function (assert) {
    assert.expect(5);

    this.server.post('/totp/keys/test', (schema, req) => {
      assert.ok(true, 'Request made to save key');
      return JSON.parse(req.requestBody);
    });

    this.model = this.store.createRecord('totp-key');

    this.onSubmit = () => assert.ok(true, 'onSubmit callback fires on save success');
    await render(hbs`
      <TotpEdit
        @mode="create"
        @onSubmit={{this.onSubmit}}
        @model={{this.model}}
    />
    `);

    assert.dom('[data-test-secret-header]').hasText('Create a TOTP key', 'Form title renders');

    // switch to non-generated form fields
    await click('[data-test-radio="Other service"]');

    // check validation errors
    await click(GENERAL.saveButton);

    const validationErrors = findAll(GENERAL.inlineAlert);
    assert.dom(validationErrors[0]).hasText(`Name can't be blank.`, 'Validation messages are shown for name');
    assert
      .dom(validationErrors[1])
      .hasText(
        `Key can't be blank if key is being passed from another service and the URL is empty.`,
        'Validation messages are shown for issuer'
      );
    assert.dom(validationErrors[2]).hasText('There are 2 errors with this form.', 'Renders form error count');

    await fillIn('[data-test-input="name"]', 'test');
    await fillIn('[data-test-input="key"]', 'test');

    await click(GENERAL.saveButton);
  });

  test('it should toggle groups according to generate', async function (assert) {
    assert.expect(4);

    this.model = this.store.createRecord('totp-key');
    this.onSubmit = () => assert.ok(true, 'onSubmit callback fires on save success');

    await render(hbs`
      <TotpEdit
        @mode="create"
        @onSubmit={{this.onSubmit}}
        @model={{this.model}}
    />
    `);

    // check generated groups
    assert.dom(SELECTORS.toggleGroup('TOTP Code Options')).exists('Common group is shown');
    assert.dom(SELECTORS.toggleGroup('Provider Options')).exists('Generated exclusive group is shown');

    // switch to non-generated form fields
    await click('[data-test-radio="Other service"]');

    // check non generated groups
    assert.dom(SELECTORS.toggleGroup('TOTP Code Options')).exists('Common group is shown');
    assert
      .dom(SELECTORS.toggleGroup('Provider Options'))
      .doesNotExist('Generated exclusive group is not shown');
  });
});
